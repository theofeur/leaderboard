<!DOCTYPE html>
<html lang="fr">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>League Leaderboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Gaming House SoloQ</h1>

  <!-- Onglets -->
  <div id="tabs">
    <div id="tab-buttons">
      <button onclick="showTab('leaderboard')">üèÜ Leaderboard</button>
      <button onclick="showTab('history')">üìú Historique</button>
      <button id="mode-toggle">üí° Mode</button>
    </div>
  </div>
  <!-- Section leaderboard -->
  <section id="leaderboard-tab">
    <table id="leaderboard">
      <thead>
        <tr>
          <th>#</th>
          <th data-sort="name">Joueur</th>
          <th data-sort="tier">Tier</th>
          <th data-sort="lp">LP</th>
          <th data-sort="winrate">Winrate</th>
          <th data-sort="stats">Stats</th>
          <th data-sort="lastGameTimestamp">Derni√®re partie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Section historique -->
  <section id="history-tab" style="display: none;">
    <table id="matchHistory">
      <thead>
        <tr>
          <th>Date</th>
          <th>Joueur</th>
          <th>Champion</th>
          <th>R√©sultat</th>
          <th>KDA</th>
          <th>Dur√©e</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    let data = [];

    const tierOrder = {
      "UNRANKED": 0,
      "IRON": 1,
      "BRONZE": 2,
      "SILVER": 3,
      "GOLD": 4,
      "PLATINUM": 5,
      "EMERALD": 6,
      "DIAMOND": 7,
      "MASTER": 8,
      "GRANDMASTER": 8,
      "CHALLENGER": 8
    };

    const rankOrder = {
      "IV": 1,
      "III": 2,
      "II": 3,
      "I": 4
    };

    function showTab(tab) {
      document.getElementById("leaderboard-tab").style.display = tab === "leaderboard" ? "block" : "none";
      document.getElementById("history-tab").style.display = tab === "history" ? "block" : "none";

      document.querySelectorAll("#tab-buttons button").forEach(btn => btn.classList.remove("active"));
      document.querySelector(`#tab-buttons button[onclick="showTab('${tab}')"]`).classList.add("active");
    }

    function timeSince(timestampMs) {
        if (!timestampMs) return "Aucune partie r√©cente";

        const now = Date.now();
        const diffMs = now - timestampMs;
        const seconds = Math.floor(diffMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `il y a ${days} jour${days > 1 ? 's' : ''}`;
        if (hours > 0) return `il y a ${hours} heure${hours > 1 ? 's' : ''}`;
        if (minutes > 0) return `il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
        return `Il y a quelques secondes`;
    }

    function displayLeaderboard(sortedData) {
        const tbody = document.querySelector("#leaderboard tbody");
        tbody.innerHTML = "";

        sortedData.forEach((player, index) => {
            const imgTier = `assets/tiers/${player.tier.toLowerCase()}.png`;
            const imgIcon = `https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${player.profileIconId}.png`;
            const [playerName, playerTag] = player.name.split("#");
            const lastGame = timeSince(player.lastGameTimestamp);

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td class="highlight">
                  <img src="${imgIcon}" alt="Icon" style="width: 24px; vertical-align: middle; border-radius: 50%; margin-right: 8px;" />
                  ${player.name}
                <a href="https://www.op.gg/summoners/euw/${playerName}-${playerTag}" target="_blank">
                  <img src="assets/opgg-icon.png" alt="OP.GG" class="opgg-icon" />
                </a>
                </td>
                <td>
                    <img src="${imgTier}" alt="${player.tier}" style="width: 30px; vertical-align: middle; margin-right: 8px;" />
                    ${player.tier} ${player.rank}
                </td>
                <td>${player.lp} LP</td>
                <td>${player.winrate.toFixed(1)}%</td>
                <td>${player.wins}W / ${player.losses}L</td>
                <td>${lastGame}</td> 
            `;
            tbody.appendChild(tr);
        });
    }

    let currentSort = { column: null, direction: 1 };

    function displayMatchHistory(matches, profileIconsMap) {
        const tbody = document.querySelector("#matchHistory tbody");
        tbody.innerHTML = "";

        matches.sort((a, b) => b.timestamp - a.timestamp); // du plus r√©cent au plus ancien

        matches.forEach(match => {
          const date = new Date(match.timestamp).toLocaleString("fr-FR");
          const result = match.win ? "‚úÖ Victoire" : "‚ùå D√©faite";
          const kda = `${match.kills}/${match.deaths}/${match.assists}`;
          const durationMin = Math.floor(match.duration / 60);
          const durationSec = match.duration % 60;

          // R√©cup√©rer l'icone du joueur dans la map, sinon ic√¥ne par d√©faut '0'
          const iconId = profileIconsMap[match.player] || '0';
          const imgPlayerIcon = `https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${iconId}.png`;

          const tr = document.createElement("tr");
          tr.className = match.win ? "win" : "lose";

          tr.innerHTML = `
            <td>${date}</td>
            <td>
              <img 
                src="${imgPlayerIcon}" 
                alt="avatar" 
                width="24" height="24" 
                style="vertical-align: middle; border-radius: 50%; margin-right: 6px;"
              >
              ${match.player}
            </td>
            <td>
              <img 
                src="https://ddragon.leagueoflegends.com/cdn/14.10.1/img/champion/${match.champion}.png" 
                alt="${match.champion}" 
                width="24" height="24" 
                style="vertical-align: middle; margin-right: 6px;"
              >
              ${match.champion}
            </td>
            <td>${result}</td>
            <td>${kda}</td>
            <td>${durationMin}m ${durationSec}s</td>
          `;
          tbody.appendChild(tr);
        });
      }




    function sortDataBy(column) {
        const sorted = [...data].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        // Gestion sp√©ciale pour certains types de donn√©es
        if (column === "name") {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
        } else if (column === "winrate") {
          valA = parseFloat(valA);
          valB = parseFloat(valB);
        } else if (column === "tier") {
          const tierA = tierOrder[a.tier.toUpperCase()] || 0;
          const tierB = tierOrder[b.tier.toUpperCase()] || 0;
          if (tierA !== tierB) return (tierB - tierA) * currentSort.direction;

          const rankA = rankOrder[a.rank.toUpperCase()] || 0;
          const rankB = rankOrder[b.rank.toUpperCase()] || 0;
          if (rankA !== rankB) return (rankB - rankA) * currentSort.direction;

          return (b.lp - a.lp) * currentSort.direction;
        } else if (column === "lastGameTimestamp") {
          valA = a.lastGameTimestamp || 0;
          valB = b.lastGameTimestamp || 0;
        }

        // Comparaison g√©n√©rique
        if (valA < valB) return -1 * currentSort.direction;
        if (valA > valB) return 1 * currentSort.direction;
        return 0;
      });

      displayLeaderboard(sorted);

      // ‚úÖ Mise √† jour visuelle des fl√®ches de tri
      document.querySelectorAll("th[data-sort]").forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
      });
      const activeTh = document.querySelector(`th[data-sort="${column}"]`);
      if (activeTh) {
        activeTh.classList.add(currentSort.direction === 1 ? "sorted-asc" : "sorted-desc");
      }
    }


    // Ajout d‚Äôun √©couteur sur chaque <th>
    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        const column = th.getAttribute("data-sort");
        if (currentSort.column === column) {
          currentSort.direction *= -1; // toggle asc/desc
        } else {
          currentSort.column = column;
          currentSort.direction = 1;
        }
        sortDataBy(column);
      });
    });


  let profileIconsMap = {};

  // Initial fetch and display
  fetch(`leaderboard.json?timestamp=${new Date().getTime()}`)
    .then((res) => res.json())
    .then((jsonData) => {
      data = jsonData.players;

      // Construire la map nom->profileIconId
      profileIconsMap = {};
      data.forEach(player => {
        profileIconsMap[player.name] = player.profileIconId;
      });

      // Appeler displayMatchHistory en passant la map
      displayMatchHistory(jsonData.global_match_history || [], profileIconsMap);

      currentSort = { column: "tier", direction: 1 };
      sortDataBy("tier");
    });


    // üé® Mode sombre / clair
    const toggleButton = document.getElementById("mode-toggle");
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") document.body.classList.add("dark-mode");

    toggleButton.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
    });
  </script>
</body>
</html>
