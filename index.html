<!DOCTYPE html>
<html lang="fr">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>League Leaderboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Gaming House SoloQ</h1>
  <div class="theme-toggle">
    <label class="switch">
      <input type="checkbox" id="themeCheckbox" onchange="toggleTheme()">
      <span class="slider round">
        <span class="icon sun">‚òÄÔ∏è</span>
        <span class="icon moon">üåô</span>
      </span>
    </label>
  </div>
  <!-- Onglets -->
  <div id="tabs">
    <div id="tab-buttons">
      <button data-tab="leaderboard-tab" class="tab-btn">Leaderboard</button>
      <button data-tab="history-tab" class="tab-btn">Historique</button>
    </div>    
  </div>
  <div class="tab-container">
  <!-- Section leaderboard -->
  <section id="leaderboard-tab" class="tab-content active">
    <table id="leaderboard">
      <thead>
        <tr>
          <th>#</th>
          <th data-sort="name">Joueur</th>
          <th data-sort="tier">Tier</th>
          <th data-sort="lp">LP</th>
          <th data-sort="winrate">Winrate</th>
          <th data-sort="stats">Stats</th>
          <th data-sort="lastGameTimestamp">Derni√®re partie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>


  <!-- Section historique -->
  <section id="history-tab" class="tab-content">
    <table id="matchHistory">
      <thead>
        <tr>
          <th>Date</th>
          <th>Joueur</th>
          <th>Champion</th>
          <th>R√¥le</th> 
          <th>R√©sultat</th>
          <th>KDA</th>
          <th>Dur√©e</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<!-- POPUP -->
<div id="playerModal" class="modal hidden">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <div id="modalStats">Statistiques en cours de chargement...</div>
  </div>
</div>

  <script type="module">
    import { showPlayerModal } from './modal.js';
    import { getStreakValue } from './streak.js';
    import { getRoleIcon } from './roleIcon.js';
    import { getKdaClass } from './kdaClass.js';
    import { timeSince, switchTab, displayLeaderboard, waitForImagesToLoad } from './utils.js';



    let allMatches = [];
      // Initial fetch and display
  fetch(`leaderboard.json?timestamp=${new Date().getTime()}`)
    .then((res) => res.json())
    .then((jsonData) => {
      data = jsonData.players;
      allMatches = jsonData.global_match_history || [];

      // Construire la map nom->profileIconId
      profileIconsMap = {};
      data.forEach(player => {
        profileIconsMap[player.name] = player.profileIconId;
      });

      // Appeler displayMatchHistory en passant la map
      displayMatchHistory(allMatches, profileIconsMap);
      displayLeaderboard(data, allMatches);
      currentSort = { column: "tier", direction: 1 };
      sortDataBy("tier");
      switchTab('leaderboard-tab');
    });

  window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      const isLight = savedTheme === 'light';
      if (isLight) document.body.classList.add('light-mode');
      document.getElementById('themeCheckbox').checked = isLight;

      // üü¢ Active le bon onglet (au lieu de modifier manuellement les classes)
      switchTab('leaderboard-tab');
    });
    let data = [];

    const tierOrder = {
      "UNRANKED": 0,
      "IRON": 1,
      "BRONZE": 2,
      "SILVER": 3,
      "GOLD": 4,
      "PLATINUM": 5,
      "EMERALD": 6,
      "DIAMOND": 7,
      "MASTER": 8,
      "GRANDMASTER": 8,
      "CHALLENGER": 8
    };

    const rankOrder = {
      "IV": 1,
      "III": 2,
      "II": 3,
      "I": 4
    };



    document.querySelectorAll("#tab-buttons .tab-btn").forEach(button => {
    button.addEventListener("click", () => {
      const tab = button.getAttribute("data-tab");
      switchTab(tab);
    });
  });





    let currentSort = { column: null, direction: 1 };

    function displayMatchHistory(matches, profileIconsMap) {
        const tbody = document.querySelector("#matchHistory tbody");
        tbody.innerHTML = "";

        matches.sort((a, b) => b.timestamp - a.timestamp); // du plus r√©cent au plus ancien

        matches.forEach(match => {
          const date = new Date(match.timestamp).toLocaleString("fr-FR");
          const durationMin = Math.floor(match.duration / 60);
          const durationSec = match.duration % 60;
          const kda = `${match.kills}/${match.deaths}/${match.assists}`;
          const iconId = profileIconsMap[match.player] || '0';

          const imgPlayerIcon = `https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${iconId}.png`;
          const imgChampion = `https://ddragon.leagueoflegends.com/cdn/14.10.1/img/champion/${match.champion}.png`;
          const roleIcon = getRoleIcon(match.role || ""); // Ajout ic√¥ne de r√¥le

          const tr = document.createElement("tr");
          tr.className = match.win ? "win-row" : "lose-row";

          const resultBadge = match.win
            ? `<span class="badge win">Victoire</span>`
            : `<span class="badge lose">D√©faite</span>`;

          tr.innerHTML = `
            <td>${date}</td>
            <td>
              <img 
                class="avatar" 
                src="${imgPlayerIcon}" 
                alt="avatar"
                onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/29.png';"
              >
              ${match.player}
            </td>
            <td>
              <div class="champion-cell">
                <img class="champion-icon" src="${imgChampion}" alt="${match.champion}">
                <span>${match.champion}</span>
              </div>
            </td>
            <td>
              <img 
                class="role-icon" 
                src="${roleIcon}" 
                alt="${match.role}" 
                title="${match.role || 'Inconnu'}"
              />
            </td>
            <td>${resultBadge}</td>
            <td>${kda}</td>
            <td>${durationMin}m ${durationSec}s</td>
          `;
          tbody.appendChild(tr);
        });
      }

     //Fonction pour obtenir la couleur du KDA 




    function sortDataBy(column) {
        const sorted = [...data].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        // Gestion sp√©ciale pour certains types de donn√©es
        if (column === "name") {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
        } else if (column === "winrate") {
          valA = parseFloat(valA);
          valB = parseFloat(valB);
        } else if (column === "tier") {
          const tierA = tierOrder[a.tier.toUpperCase()] || 0;
          const tierB = tierOrder[b.tier.toUpperCase()] || 0;
          if (tierA !== tierB) return (tierB - tierA) * currentSort.direction;

          const rankA = rankOrder[a.rank.toUpperCase()] || 0;
          const rankB = rankOrder[b.rank.toUpperCase()] || 0;
          if (rankA !== rankB) return (rankB - rankA) * currentSort.direction;

          return (b.lp - a.lp) * currentSort.direction;
        } else if (column === "lastGameTimestamp") {
          valA = a.lastGameTimestamp || 0;
          valB = b.lastGameTimestamp || 0;
        }

        // Comparaison g√©n√©rique
        if (valA < valB) return -1 * currentSort.direction;
        if (valA > valB) return 1 * currentSort.direction;
        return 0;
      });

      displayLeaderboard(sorted,allMatches);

      // ‚úÖ Mise √† jour visuelle des fl√®ches de tri
      document.querySelectorAll("th[data-sort]").forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
      });
      const activeTh = document.querySelector(`th[data-sort="${column}"]`);
      if (activeTh) {
        activeTh.classList.add(currentSort.direction === 1 ? "sorted-asc" : "sorted-desc");
      }
    }


    // Ajout d‚Äôun √©couteur sur chaque <th>
    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        const column = th.getAttribute("data-sort");
        if (currentSort.column === column) {
          currentSort.direction *= -1; // toggle asc/desc
        } else {
          currentSort.column = column;
          currentSort.direction = 1;
        }
        sortDataBy(column);
      });
    });

    function toggleTheme() {
        const body = document.body;
        const isLight = body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
      }


    let profileIconsMap = {};

    const modal = document.getElementById("playerModal");
    const closeModal = document.getElementById("closeModal");
    const modalStats = document.getElementById("modalStats");

    // Fonction pour ouvrir le modal avec un joueur (popup)
  


    // Fermer le popup via bouton
    closeModal.addEventListener("click", () => {
      modal.classList.remove("modal-zoom-in", "modal-slide-right", "modal-bounce", "modal-fade-up"); // nettoie les anim d'ouverture
      modal.classList.add("modal-fade-out");

      modal.addEventListener("animationend", function handler() {
        modal.classList.add("hidden");
        modal.classList.remove("modal-fade-out");
        modal.removeEventListener("animationend", handler);
      });
    });

    // Fermer en cliquant en dehors de la box
    window.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.remove("modal-zoom-in", "modal-slide-right", "modal-bounce", "modal-fade-up"); // idem
        modal.classList.add("modal-fade-out");

        modal.addEventListener("animationend", function handler() {
          modal.classList.add("hidden");
          modal.classList.remove("modal-fade-out");
          modal.removeEventListener("animationend", handler);
        });
      }
    });

    


    // Fonction afficher l'historique d'un seul joueur
    function generatePlayerHistoryHTML(player, profileIconsMap) {
        if (!player.games || player.games.length === 0) {
          return "<p>Aucune partie jou√©e r√©cemment.</p>";
        }

        const rows = player.games
          .sort((a, b) => b.timestamp - a.timestamp)
          .map(match => {
            const date = new Date(match.timestamp).toLocaleString("fr-FR");
            const durationMin = Math.floor(match.duration / 60);
            const durationSec = match.duration % 60;
            const kda = `${match.kills}/${match.deaths}/${match.assists}`;
            const iconId = profileIconsMap[player.name] || '0';

            const imgPlayerIcon = `https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${iconId}.png`;
            const imgChampion = `https://ddragon.leagueoflegends.com/cdn/14.10.1/img/champion/${match.champion}.png`;

            const resultBadge = match.win
              ? `<span class="badge win">Victoire</span>`
              : `<span class="badge lose">D√©faite</span>`;

            return `
              <tr class="${match.win ? "win-row" : "lose-row"}">
                <td>${date}</td>
                <td>
                  <img class="avatar" src="${imgPlayerIcon}" alt="avatar">
                  ${player.name}
                </td>
                <td>
                  <div class="champion-cell">
                    <img class="champion-icon" src="${imgChampion}" alt="${match.champion}">
                    <span>${match.champion}</span>
                  </div>
                </td>
                <td>${resultBadge}</td>
                <td>${kda}</td>
                <td>${durationMin}m ${durationSec}s</td>
              </tr>`;
          }).join("");

        return `
          <h3>Historique des matchs</h3>
          <table class="match-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Joueur</th>
                <th>Champion</th>
                <th>R√©sultat</th>
                <th>K/D/A</th>
                <th>Dur√©e</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>`;
      }



      // Fonction pour obtenir l'ic√¥ne de r√¥le  



      //Fonction pour obtenir la streak
      
  </script>
  
</body>
</html>
