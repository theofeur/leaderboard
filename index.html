<!DOCTYPE html>
<html lang="fr">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>League Leaderboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Gaming House SoloQ</h1>
  <div class="theme-toggle">
    <label class="switch">
      <input type="checkbox" id="themeCheckbox" onchange="toggleTheme()">
      <span class="slider round">
        <span class="icon sun">‚òÄÔ∏è</span>
        <span class="icon moon">üåô</span>
      </span>
    </label>
  </div>
  <!-- Onglets -->
  <div id="tabs">
    <div id="tab-buttons">
      <button onclick="switchTab('leaderboard-tab')" class="tab-btn">Leaderboard</button>
      <button onclick="switchTab('history-tab')" class="tab-btn">Historique</button>
    </div>
  </div>
  <div class="tab-container">
  <!-- Section leaderboard -->
  <section id="leaderboard-tab" class="tab-content active">
    <table id="leaderboard">
      <thead>
        <tr>
          <th>#</th>
          <th data-sort="name">Joueur</th>
          <th data-sort="tier">Tier</th>
          <th data-sort="lp">LP</th>
          <th data-sort="winrate">Winrate</th>
          <th data-sort="stats">Stats</th>
          <th data-sort="lastGameTimestamp">Derni√®re partie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>


  <!-- Section historique -->
  <section id="history-tab" class="tab-content">
    <table id="matchHistory">
      <thead>
        <tr>
          <th>Date</th>
          <th>Joueur</th>
          <th>Champion</th>
          <th>R√¥le</th> 
          <th>R√©sultat</th>
          <th>KDA</th>
          <th>Dur√©e</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<!-- POPUP -->
<div id="playerModal" class="modal hidden">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <div id="modalStats">Statistiques en cours de chargement...</div>
  </div>
</div>

  <script>
    let allMatches = [];
      // Initial fetch and display
  fetch(`leaderboard.json?timestamp=${new Date().getTime()}`)
    .then((res) => res.json())
    .then((jsonData) => {
      data = jsonData.players;
      allMatches = jsonData.global_match_history || [];

      // Construire la map nom->profileIconId
      profileIconsMap = {};
      data.forEach(player => {
        profileIconsMap[player.name] = player.profileIconId;
      });

      // Appeler displayMatchHistory en passant la map
      displayMatchHistory(allMatches, profileIconsMap);
      displayLeaderboard(data);
      currentSort = { column: "tier", direction: 1 };
      sortDataBy("tier");
      switchTab('leaderboard-tab');
    });

  window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      const isLight = savedTheme === 'light';
      if (isLight) document.body.classList.add('light-mode');
      document.getElementById('themeCheckbox').checked = isLight;

      // üü¢ Active le bon onglet (au lieu de modifier manuellement les classes)
      switchTab('leaderboard-tab');
    });
    let data = [];

    const tierOrder = {
      "UNRANKED": 0,
      "IRON": 1,
      "BRONZE": 2,
      "SILVER": 3,
      "GOLD": 4,
      "PLATINUM": 5,
      "EMERALD": 6,
      "DIAMOND": 7,
      "MASTER": 8,
      "GRANDMASTER": 8,
      "CHALLENGER": 8
    };

    const rankOrder = {
      "IV": 1,
      "III": 2,
      "II": 3,
      "I": 4
    };

    function switchTab(tabId) {
        const container = document.querySelector('.tab-container');
        const tabs = document.querySelectorAll('.tab-content');
        const buttons = document.querySelectorAll('.tab-btn');

        // D√©sactiver tous les onglets et boutons
        tabs.forEach(tab => tab.classList.remove('active'));
        buttons.forEach(btn => btn.classList.remove('active'));

        // Activer l‚Äôonglet et le bouton correspondant
        const activeTab = document.getElementById(tabId);
        activeTab.classList.add('active');

        const activeBtn = document.querySelector(`[onclick="switchTab('${tabId}')"]`);
        if (activeBtn) activeBtn.classList.add('active');

        // Ajuster la hauteur
        container.style.height = activeTab.scrollHeight + 'px';
      }



    function timeSince(timestampMs) {
        if (!timestampMs) return "Aucune partie r√©cente";

        const now = Date.now();
        const diffMs = now - timestampMs;
        const seconds = Math.floor(diffMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `il y a ${days} jour${days > 1 ? 's' : ''}`;
        if (hours > 0) return `il y a ${hours} heure${hours > 1 ? 's' : ''}`;
        if (minutes > 0) return `il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
        return `Il y a quelques secondes`;
    }

    function displayLeaderboard(sortedData) {
        const tbody = document.querySelector("#leaderboard tbody");
        tbody.innerHTML = "";

        sortedData.forEach((player, index) => {
            const imgTier = `assets/tiers/${player.tier.toLowerCase()}.png`;
            const imgIcon = `https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${player.profileIconId}.png`;
            const [playerName, playerTag] = player.name.split("#");
            const lastGame = timeSince(player.lastGameTimestamp);
            const playerMatches = allMatches.filter(m => m.player === player.name)
                                   .sort((a,b) => b.timestamp - a.timestamp);

            // Calcul streak avec ta fonction (√† ajuster selon ton code)
            const streakValue = getStreakValue(playerMatches);                       
            let streakHtml = '';
            if (streakValue > 0) {
              streakHtml = `
            <span class="streak-badge" style="
              position: relative;
              display: inline-flex;
              align-items: center;
              gap: 6px;
              background-color: #4caf50;
              color: white;
              font-weight: 700;
              font-size: 13px;
              padding: 3px 8px;
              border-radius: 12px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.15);
              margin-left: 12px;
              user-select: none;
              cursor: default;
              animation: pop-in 0.6s ease forwards;
            ">
              üî• +${streakValue} Win Streak

              <span class="tooltip" style="
                visibility: hidden;
                opacity: 0;
                width: max-content;
                max-width: 180px;
                background-color: #222;
                color: #fff;
                text-align: center;
                border-radius: 6px;
                padding: 5px 8px;
                position: absolute;
                z-index: 10;
                bottom: 125%; /* au dessus du badge */
                left: 50%;
                transform: translateX(-50%);
                transition: opacity 0.3s;
                font-size: 11px;
                pointer-events: none;
                box-shadow: 0 0 6px rgba(0,0,0,0.3);
              ">
                Victoires cons√©cutives : ${streakValue}
                <span style="
                  position: absolute;
                  top: 100%;
                  left: 50%;
                  margin-left: -5px;
                  border-width: 5px;
                  border-style: solid;
                  border-color: #222 transparent transparent transparent;
                "></span>
              </span>
            </span>
          `;
            } else if (streakValue < 0) {
              streakHtml = `
            <span class="streak-badge" style="
              position: relative;
              display: inline-flex;
              align-items: center;
              gap: 6px;
              background-color: #f44336;
              color: white;
              font-weight: 700;
              font-size: 13px;
              padding: 3px 8px;
              border-radius: 12px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.15);
              margin-left: 12px;
              user-select: none;
              cursor: default;
              animation: pop-in 0.6s ease forwards;
            ">
              ‚ùÑÔ∏è ${-streakValue} Lose Streak

              <span class="tooltip" style="
                visibility: hidden;
                opacity: 0;
                width: max-content;
                max-width: 180px;
                background-color: #222;
                color: #fff;
                text-align: center;
                border-radius: 6px;
                padding: 5px 8px;
                position: absolute;
                z-index: 10;
                bottom: 125%;
                left: 50%;
                transform: translateX(-50%);
                transition: opacity 0.3s;
                font-size: 11px;
                pointer-events: none;
                box-shadow: 0 0 6px rgba(0,0,0,0.3);
              ">
                D√©faites cons√©cutives : ${-streakValue}
                <span style="
                  position: absolute;
                  top: 100%;
                  left: 50%;
                  margin-left: -5px;
                  border-width: 5px;
                  border-style: solid;
                  border-color: #222 transparent transparent transparent;
                "></span>
              </span>
            </span>
          `;
            } else {
              streakHtml = '';
            }
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td class="highlight">
                <img 
                  src="https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${player.profileIconId}.png" 
                  alt="Icon" 
                  style="width: 24px; vertical-align: middle; border-radius: 50%; margin-right: 8px;"
                  onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/29.png';"
                />
                ${player.name}
                <a href="https://www.op.gg/summoners/euw/${playerName}-${playerTag}" target="_blank" class="opgg-link">
                  <img src="assets/opgg-icon.png" alt="OP.GG" class="opgg-icon"/></a>
                ${streakHtml}
              </td>
              <td>
                  <img src="${imgTier}" alt="${player.tier}" style="width: 30px; vertical-align: middle; margin-right: 8px;" />
                  ${player.tier} ${player.rank}
              </td>
              <td>${player.lp} LP</td>
              <td>${player.winrate.toFixed(1)}%</td>
              <td>${player.wins}W / ${player.losses}L</td>
              <td>${lastGame}</td> 
            `;

            tr.addEventListener("click", () => {
            showPlayerModal(player); // Appelle ta fonction de popup
            });            
            // Emp√™che l‚Äôouverture du popup lors du clic sur l'ic√¥ne OP.GG
            const opggLink = tr.querySelector(".opgg-link");
            if (opggLink) {
              opggLink.addEventListener("click", (event) => {
                event.stopPropagation();
              });

          }
          
            tbody.appendChild(tr);
            // Apr√®s avoir rempli le tbody :
          waitForImagesToLoad(document.getElementById("leaderboard-tab"), () => {
            const container = document.querySelector(".tab-container");
            const activeTab = document.querySelector(".tab-content.active");
            if (container && activeTab) {
              container.style.height = activeTab.scrollHeight + "px";
            }
          });
        });
    }

    let currentSort = { column: null, direction: 1 };

    function displayMatchHistory(matches, profileIconsMap) {
        const tbody = document.querySelector("#matchHistory tbody");
        tbody.innerHTML = "";

        matches.sort((a, b) => b.timestamp - a.timestamp); // du plus r√©cent au plus ancien

        matches.forEach(match => {
          const date = new Date(match.timestamp).toLocaleString("fr-FR");
          const durationMin = Math.floor(match.duration / 60);
          const durationSec = match.duration % 60;
          const kda = `${match.kills}/${match.deaths}/${match.assists}`;
          const iconId = profileIconsMap[match.player] || '0';

          const imgPlayerIcon = `https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${iconId}.png`;
          const imgChampion = `https://ddragon.leagueoflegends.com/cdn/14.10.1/img/champion/${match.champion}.png`;
          const roleIcon = getRoleIcon(match.role || ""); // Ajout ic√¥ne de r√¥le

          const tr = document.createElement("tr");
          tr.className = match.win ? "win-row" : "lose-row";

          const resultBadge = match.win
            ? `<span class="badge win">Victoire</span>`
            : `<span class="badge lose">D√©faite</span>`;

          tr.innerHTML = `
            <td>${date}</td>
            <td>
              <img 
                class="avatar" 
                src="${imgPlayerIcon}" 
                alt="avatar"
                onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/29.png';"
              >
              ${match.player}
            </td>
            <td>
              <div class="champion-cell">
                <img class="champion-icon" src="${imgChampion}" alt="${match.champion}">
                <span>${match.champion}</span>
              </div>
            </td>
            <td>
              <img 
                class="role-icon" 
                src="${roleIcon}" 
                alt="${match.role}" 
                title="${match.role || 'Inconnu'}"
              />
            </td>
            <td>${resultBadge}</td>
            <td>${kda}</td>
            <td>${durationMin}m ${durationSec}s</td>
          `;
          tbody.appendChild(tr);
        });
      }

     //Fonction pour obtenir la couleur du KDA 
    function getKdaClass(kda) {
        if (kda <= 0.3) return "kda-blood-red";
        if (kda < 1) return "kda-dark-red";
        if (kda > 4) return "kda-gold";
        if (kda > 2.5) return "kda-cyan";
        else return "kda-normal";
      }



    function sortDataBy(column) {
        const sorted = [...data].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        // Gestion sp√©ciale pour certains types de donn√©es
        if (column === "name") {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
        } else if (column === "winrate") {
          valA = parseFloat(valA);
          valB = parseFloat(valB);
        } else if (column === "tier") {
          const tierA = tierOrder[a.tier.toUpperCase()] || 0;
          const tierB = tierOrder[b.tier.toUpperCase()] || 0;
          if (tierA !== tierB) return (tierB - tierA) * currentSort.direction;

          const rankA = rankOrder[a.rank.toUpperCase()] || 0;
          const rankB = rankOrder[b.rank.toUpperCase()] || 0;
          if (rankA !== rankB) return (rankB - rankA) * currentSort.direction;

          return (b.lp - a.lp) * currentSort.direction;
        } else if (column === "lastGameTimestamp") {
          valA = a.lastGameTimestamp || 0;
          valB = b.lastGameTimestamp || 0;
        }

        // Comparaison g√©n√©rique
        if (valA < valB) return -1 * currentSort.direction;
        if (valA > valB) return 1 * currentSort.direction;
        return 0;
      });

      displayLeaderboard(sorted);

      // ‚úÖ Mise √† jour visuelle des fl√®ches de tri
      document.querySelectorAll("th[data-sort]").forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
      });
      const activeTh = document.querySelector(`th[data-sort="${column}"]`);
      if (activeTh) {
        activeTh.classList.add(currentSort.direction === 1 ? "sorted-asc" : "sorted-desc");
      }
    }


    // Ajout d‚Äôun √©couteur sur chaque <th>
    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        const column = th.getAttribute("data-sort");
        if (currentSort.column === column) {
          currentSort.direction *= -1; // toggle asc/desc
        } else {
          currentSort.column = column;
          currentSort.direction = 1;
        }
        sortDataBy(column);
      });
    });

    function toggleTheme() {
        const body = document.body;
        const isLight = body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
      }


    let profileIconsMap = {};

    const modal = document.getElementById("playerModal");
    const closeModal = document.getElementById("closeModal");
    const modalStats = document.getElementById("modalStats");

    // Fonction pour ouvrir le modal avec un joueur (popup)
    function showPlayerModal(player) {
      const playerMatches = allMatches.filter(match => match.player === player.name);

       // Calcul streak et affichage
      const streakValue = getStreakValue(playerMatches);
      let streakHtml = '';
      if (streakValue > 0) {
        streakHtml = `
          <span style="
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #4caf50;
            color: white;
            font-weight: 700;
            font-size: 13px;
            padding: 3px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            margin-left: 12px;
            user-select: none;
            cursor: default;
            animation: pop-in 0.6s ease forwards;
          ">
            üî• +${streakValue} Win Streak

            <span style="
              visibility: hidden;
              opacity: 0;
              width: max-content;
              max-width: 180px;
              background-color: #222;
              color: #fff;
              text-align: center;
              border-radius: 6px;
              padding: 5px 8px;
              position: absolute;
              z-index: 10;
              bottom: 125%; /* au dessus du badge */
              left: 50%;
              transform: translateX(-50%);
              transition: opacity 0.3s;
              font-size: 11px;
              pointer-events: none;
              box-shadow: 0 0 6px rgba(0,0,0,0.3);
            ">
              Victoires cons√©cutives : ${streakValue}
              <span style="
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: #222 transparent transparent transparent;
              "></span>
            </span>
          </span>

          <style>
            span:hover > span {
              visibility: visible !important;
              opacity: 1 !important;
            }
          </style>
        `;
      } else if (streakValue < 0) {
        streakHtml = `
          <span style="
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #f44336;
            color: white;
            font-weight: 700;
            font-size: 13px;
            padding: 3px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            margin-left: 12px;
            user-select: none;
            cursor: default;
            animation: pop-in 0.6s ease forwards;
          ">
            ‚ùÑÔ∏è ${-streakValue} Lose Streak

            <span style="
              visibility: hidden;
              opacity: 0;
              width: max-content;
              max-width: 180px;
              background-color: #222;
              color: #fff;
              text-align: center;
              border-radius: 6px;
              padding: 5px 8px;
              position: absolute;
              z-index: 10;
              bottom: 125%;
              left: 50%;
              transform: translateX(-50%);
              transition: opacity 0.3s;
              font-size: 11px;
              pointer-events: none;
              box-shadow: 0 0 6px rgba(0,0,0,0.3);
            ">
              D√©faites cons√©cutives : ${-streakValue}
              <span style="
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: #222 transparent transparent transparent;
              "></span>
            </span>
          </span>

          <style>
            span:hover > span {
              visibility: visible !important;
              opacity: 1 !important;
            }
          </style>
        `;
      }

      // Calcul des moyennes globales
      let totalGold = 0, totalCs = 0, totalKills = 0, totalDeaths = 0, totalAssists = 0, totalDuration = 0, totalTeamKills = 0;
      playerMatches.forEach(m => {
        totalGold += m.gold || 0;
        totalCs += m.cs || 0;
        totalKills += m.kills || 0;
        totalDeaths += m.deaths || 0;
        totalAssists += m.assists || 0;
        totalDuration += m.duration || 1;
        totalTeamKills += m.team_kills || 0;
      });

      const nbMatches = playerMatches.length || 1;
      const goldPerMinAvg = (totalGold / totalDuration) * 60;
      const csPerMinAvg = (totalCs / totalDuration) * 60;
      const kdaAvg = (totalKills + totalAssists) / Math.max(totalDeaths, 1);
      const kpAvg = totalTeamKills > 0 ? (((totalKills + totalAssists) / totalTeamKills) * 100).toFixed(0) : "0";

      modalStats.innerHTML = `
  <div class="modal-header">
    <div class="player-info">
      <img 
        src="https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${player.profileIconId}.png"
        alt="Avatar"
        class="modal-avatar"
        onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/29.png';"
      />
      <span class="modal-name">${player.name}</span>
      ${streakHtml}
    </div>
    <div class="rank-info" style="color: #aaa;">
      <img 
        src="assets/tiers/${player.tier.toLowerCase()}.png"
        alt="${player.tier}"
        class="rank-icon"
      />
      <div class="rank-text">${player.tier} ${player.rank} (${player.lp} LP)</div>
      <div class="rank-winrate">${player.winrate.toFixed(2)}% Winrate</div>
      <div class="rank-winrate">${player.wins}W / ${player.losses}L</div>

      <!-- Winrate par r√¥le -->
      <div class="role-averages" style="margin-top: 8px; font-size: 13px; font-weight: 600; color: inherit; ">
        <div style="margin-bottom: 6px; font-weight: 700;">Winrate par r√¥le :</div>
        ${(() => {
          const rolesMap = { TOP: [], JUNGLE: [], MIDDLE: [], BOTTOM: [], UTILITY: [] };
          playerMatches.forEach(match => {
            if (rolesMap[match.role]) rolesMap[match.role].push(match);
          });
          return Object.entries(rolesMap).map(([role, matches]) => {
            if (matches.length === 0) return '';
            const wins = matches.filter(m => m.win).length;
            const losses = matches.length - wins;
            const winrate = ((wins / matches.length) * 100).toFixed(0);
            return `
              <div style="display: flex; align-items: middle; text-align:middle; gap: 6px; margin-bottom: 2px; margin-left: 22px;">
                <img src="${getRoleIcon(role)}" alt="${role}" class="role-icon" style="width: 16px; height: 16px;" />
                <span>${winrate}% (${wins}W ${losses}L)</span>
              </div>
            `;
          }).join('');
        })()}
      </div>
    </div>
  </div>

  <div class="modal-details-flex">
    
    <!-- Section Champions jou√©s reste √† sa place -->
    <div class="champion-stats-section"></div>

    <!-- Section historique avec moyennes globales juste au-dessus -->
    <div class="match-history-section">

      <div style="margin: 10px 0 15px 0; display: flex; flex-direction: column; gap: 10px;">
        <div class="player-averages" style="font-weight: 600;">
          <div style="margin-bottom: 6px; font-weight: 700;">Moyennes globales :</div>
          KP : ${kpAvg}% &nbsp;&nbsp;
          <img src="assets/COIN.png" alt="Gold/min" title="Gold/min" class="header-icon"/><span>/min</span> : ${goldPerMinAvg.toFixed(1)} &nbsp;&nbsp;
          <img src="assets/MINION.png" alt="CS/min" title="CS/min" class="header-icon"/><span>/min</span> : ${csPerMinAvg.toFixed(1)} &nbsp;&nbsp;
          KDA : ${kdaAvg.toFixed(2)}
        </div>

        <div class="last-games-title">Historique des matchs r√©cents</div>
      </div>

      <table class="player-history-table">
        <thead>
          <tr>
            <th>Champion</th>
            <th>R√¥le</th>
            <th>Score</th>
            <th>KP</th>
            <th>
              <img src="assets/MINION.png" alt="CS/min" title="CS/min" class="header-icon"/><span>/min</span>
            </th>
            <th>R√©sultat</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="playerHistoryBody"></tbody>
      </table>
    </div>

  </div>
`;


      // === Stats par champion ===
      const championStatsMap = {};
      playerMatches.forEach(match => {
        const champ = match.champion;
        if (!championStatsMap[champ]) {
          championStatsMap[champ] = {
            games: 0,
            wins: 0,
            kills: 0,
            deaths: 0,
            assists: 0,
            cs: 0,
            duration: 0
          };
        }
        const stats = championStatsMap[champ];
        stats.games += 1;
        if (match.win) stats.wins += 1;
        stats.kills += match.kills || 0;
        stats.deaths += match.deaths || 0;
        stats.assists += match.assists || 0;
        stats.cs += match.cs || 0;
        stats.duration += match.duration || 1;
      });

      const statsContainer = modalStats.querySelector(".champion-stats-section");
      const sortedChamps = Object.entries(championStatsMap)
        .sort((a, b) => b[1].games - a[1].games);

      statsContainer.innerHTML = `<div class="champion-title">Champions jou√©s</div>`;
      sortedChamps.forEach(([champion, data]) => {
        const winrate = ((data.wins / data.games) * 100).toFixed(0);
        const kda = ((data.kills + data.assists) / Math.max(data.deaths, 1)).toFixed(2);
        const csPerMin = ((data.cs / data.duration) * 60).toFixed(1);
        const kdaClass = getKdaClass(parseFloat(kda));
        const losses = data.games - data.wins;

        statsContainer.innerHTML += `
          <div class="champion-row">
            <img src="https://ddragon.leagueoflegends.com/cdn/14.10.1/img/champion/${champion}.png" class="champion-icon" alt="${champion}">
            <div class="champion-info">
              <div><strong>${champion}</strong> (${data.games} game${data.games > 1 ? 's' : ''})</div>
              <div>Winrate: ${winrate}% (${data.wins}W ${losses}L)</div>
              <div class="kda-value">KDA: <span class="${kdaClass}">${kda}</span></div>
              <div>
                <img src="assets/MINION.png" alt="CS par minute" title="CS/min" class="header-icon cs-icon-right" />
                <span>/min : ${csPerMin}</span>
              </div>
            </div>
          </div>
        `;
      });

      // === Historique des matchs ===
      const tbody = modalStats.querySelector("#playerHistoryBody");
      if (playerMatches.length > 0) {
        playerMatches
          .sort((a, b) => b.timestamp - a.timestamp)
          .forEach(match => {
            const row = document.createElement("tr");
            row.className = match.win ? "win-row" : "lose-row";

            const date = timeSince(match.timestamp);
            const duration = match.duration || 1;
            const csPerMin = ((match.cs || 0) / duration * 60).toFixed(1);
            const teamKills = match.team_kills || 0;
            const kp = teamKills > 0 ? (((match.kills + match.assists) / teamKills) * 100).toFixed(0) : "0";
            const kpClass = kp > 60 ? 'high-kp' : '';
            const kda = `${match.kills}/${match.deaths}/${match.assists}`;
            const kdaRatio = (match.kills + match.assists) / Math.max(match.deaths, 1);
            const excellentBadge = kdaRatio > 4 && kp > 60 ? `<span class="badge-excellent">Excellent</span>` : '';
            const resultBadge = match.win
              ? `<span class="badge win">Victoire</span>`
              : `<span class="badge lose">D√©faite</span>`;

            row.innerHTML = `
              <td>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span>
                    <img 
                      src="https://ddragon.leagueoflegends.com/cdn/14.10.1/img/champion/${match.champion}.png" 
                      class="champion-icon" 
                      alt="${match.champion}">
                    ${match.champion}
                  </span>
                  ${excellentBadge}
                </div>
              </td>
              <td><img src="${getRoleIcon(match.role)}" alt="${match.role}" class="role-icon" /></td>
              <td>${kda}</td>
              <td class="kp ${kpClass}">${kp}%</td>
              <td class="cs-per-min">${csPerMin}</td>
              <td>${resultBadge}</td>
              <td>${date}</td>
            `;
            tbody.appendChild(row);
          });
      } else {
        tbody.innerHTML = `<tr><td colspan="7">Aucune partie r√©cente.</td></tr>`;
      }

      modal.classList.remove("hidden");

      // Popup animation
      modal.classList.remove("modal-fade-up");
      void modal.offsetWidth;
      modal.classList.add("modal-fade-up");
    }




    // Fermer le popup via bouton
    closeModal.addEventListener("click", () => {
      modal.classList.remove("modal-zoom-in", "modal-slide-right", "modal-bounce", "modal-fade-up"); // nettoie les anim d'ouverture
      modal.classList.add("modal-fade-out");

      modal.addEventListener("animationend", function handler() {
        modal.classList.add("hidden");
        modal.classList.remove("modal-fade-out");
        modal.removeEventListener("animationend", handler);
      });
    });

    // Fermer en cliquant en dehors de la box
    window.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.remove("modal-zoom-in", "modal-slide-right", "modal-bounce", "modal-fade-up"); // idem
        modal.classList.add("modal-fade-out");

        modal.addEventListener("animationend", function handler() {
          modal.classList.add("hidden");
          modal.classList.remove("modal-fade-out");
          modal.removeEventListener("animationend", handler);
        });
      }
    });

    // Fonction pour attendre que toutes les images soient charg√©es
    // avant d'ajuster la hauteur du conteneur
    // et d'afficher le tableau
    function waitForImagesToLoad(container, callback) {
        const images = container.querySelectorAll("img");
        let loadedCount = 0;
        const total = images.length;

        if (total === 0) return callback();

        images.forEach((img) => {
          if (img.complete) {
            loadedCount++;
            if (loadedCount === total) callback();
          } else {
            img.addEventListener("load", () => {
              loadedCount++;
              if (loadedCount === total) callback();
            });
            img.addEventListener("error", () => {
              loadedCount++;
              if (loadedCount === total) callback();
            });
          }
        });
      }


    // Fonction afficher l'historique d'un seul joueur
    function generatePlayerHistoryHTML(player, profileIconsMap) {
        if (!player.games || player.games.length === 0) {
          return "<p>Aucune partie jou√©e r√©cemment.</p>";
        }

        const rows = player.games
          .sort((a, b) => b.timestamp - a.timestamp)
          .map(match => {
            const date = new Date(match.timestamp).toLocaleString("fr-FR");
            const durationMin = Math.floor(match.duration / 60);
            const durationSec = match.duration % 60;
            const kda = `${match.kills}/${match.deaths}/${match.assists}`;
            const iconId = profileIconsMap[player.name] || '0';

            const imgPlayerIcon = `https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${iconId}.png`;
            const imgChampion = `https://ddragon.leagueoflegends.com/cdn/14.10.1/img/champion/${match.champion}.png`;

            const resultBadge = match.win
              ? `<span class="badge win">Victoire</span>`
              : `<span class="badge lose">D√©faite</span>`;

            return `
              <tr class="${match.win ? "win-row" : "lose-row"}">
                <td>${date}</td>
                <td>
                  <img class="avatar" src="${imgPlayerIcon}" alt="avatar">
                  ${player.name}
                </td>
                <td>
                  <div class="champion-cell">
                    <img class="champion-icon" src="${imgChampion}" alt="${match.champion}">
                    <span>${match.champion}</span>
                  </div>
                </td>
                <td>${resultBadge}</td>
                <td>${kda}</td>
                <td>${durationMin}m ${durationSec}s</td>
              </tr>`;
          }).join("");

        return `
          <h3>Historique des matchs</h3>
          <table class="match-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Joueur</th>
                <th>Champion</th>
                <th>R√©sultat</th>
                <th>K/D/A</th>
                <th>Dur√©e</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>`;
      }



      // Fonction pour obtenir l'ic√¥ne de r√¥le  
      function getRoleIcon(role) {
        const roleIcons = {
          TOP: "assets/roles/TOP.png",
          JUNGLE: "assets/roles/JUNGLE.png",
          MIDDLE: "assets/roles/MIDDLE.png",
          BOTTOM: "assets/roles/BOTTOM.png",
          UTILITY: "assets/roles/UTILITY.png"
        };

        return roleIcons[role] || "assets/roles/unknown.png"; // fallback en cas de r√¥le inattendu
      }


      //Fonction pour obtenir la streak
      function getStreakValue(matches) {
      if (!matches || matches.length === 0) return 0;

      let streakType = matches[0].win ? "win" : "loss";
      let streakCount = 1;

      for (let i = 1; i < matches.length; i++) {
        if ((streakType === "win" && matches[i].win) || (streakType === "loss" && !matches[i].win)) {
          streakCount++;
        } else {
          break; // streak interrompue
        }
      }

      // On ne consid√®re une streak que si elle fait 3 matchs ou plus
      if (streakCount >= 3) {
        return streakType === "win" ? streakCount : -streakCount;
      } else {
        return 0;
      }
    }

  </script>
</body>
</html>
