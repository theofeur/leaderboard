<!DOCTYPE html>
<html lang="fr">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>League Leaderboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Gaming House SoloQ Leaderboard</h1>

  <table id="leaderboard">
    <thead>
      <tr>
        <th>#</th>
        <th data-sort="name">Joueur</th>
        <th data-sort="tier">Tier</th>
        <th data-sort="lp">LP</th>
        <th data-sort="winrate">Winrate</th>
        <th data-sort="stats">Stats</th>
        <th data-sort="lastGame">Dernière partie</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let data = [];

    const tierOrder = {
      "UNRANKED": 0,
      "IRON": 1,
      "BRONZE": 2,
      "SILVER": 3,
      "GOLD": 4,
      "PLATINUM": 5,
      "EMERALD": 6,
      "DIAMOND": 7,
      "MASTER": 8,
      "GRANDMASTER": 8,
      "CHALLENGER": 8
    };

    const rankOrder = {
      "IV": 1,
      "III": 2,
      "II": 3,
      "I": 4
    };



    function timeSince(timestampMs) {
        if (!timestampMs) return "Aucune partie récente";

        const now = Date.now();
        const diffMs = now - timestampMs;
        const seconds = Math.floor(diffMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `il y a ${days} jour${days > 1 ? 's' : ''}`;
        if (hours > 0) return `il y a ${hours} heure${hours > 1 ? 's' : ''}`;
        if (minutes > 0) return `il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
        return `Il y a quelques secondes`;
    }

    function displayLeaderboard(sortedData) {
        const tbody = document.querySelector("#leaderboard tbody");
        tbody.innerHTML = "";

        sortedData.forEach((player, index) => {
            const imgTier = `assets/tiers/${player.tier.toLowerCase()}.png`;
            const imgIcon = `https://ddragon.leagueoflegends.com/cdn/14.9.1/img/profileicon/${player.profileIconId}.png`;
            const [playerName, playerTag] = player.name.split("#");
            const lastGame = timeSince(player.lastGameTimestamp);

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td class="highlight">
                  <img src="${imgIcon}" alt="Icon" style="width: 24px; vertical-align: middle; border-radius: 50%; margin-right: 8px;" />
                  ${player.name}
                <a href="https://www.op.gg/summoners/euw/${playerName}-${playerTag}" target="_blank">
                  <img src="assets/opgg-icon.png" alt="OP.GG" class="opgg-icon" />
                </a>
                </td>
                <td>
                    <img src="${imgTier}" alt="${player.tier}" style="width: 30px; vertical-align: middle; margin-right: 8px;" />
                    ${player.tier} ${player.rank}
                </td>
                <td>${player.lp} LP</td>
                <td>${player.winrate.toFixed(1)}%</td>
                <td>${player.wins}W / ${player.losses}L</td>
                <td>${lastGame}</td> <!-- Nouvelle colonne -->
            `;
            tbody.appendChild(tr);
        });
    }

    let currentSort = { column: null, direction: 1 };

    function sortDataBy(column) {
        const sorted = [...data].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        // Gestion spéciale pour certains types de données
        if (column === "name") {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
        } else if (column === "winrate") {
          valA = parseFloat(valA);
          valB = parseFloat(valB);
        } else if (column === "tier") {
          const tierA = tierOrder[a.tier.toUpperCase()] || 0;
          const tierB = tierOrder[b.tier.toUpperCase()] || 0;
          if (tierA !== tierB) return (tierB - tierA) * currentSort.direction;

          const rankA = rankOrder[a.rank.toUpperCase()] || 0;
          const rankB = rankOrder[b.rank.toUpperCase()] || 0;
          if (rankA !== rankB) return (rankB - rankA) * currentSort.direction;

          return (b.lp - a.lp) * currentSort.direction;
        } else if (column === "lastGameTimestamp") {
          valA = a.lastGameTimestamp || 0;
          valB = b.lastGameTimestamp || 0;
        }

        // Comparaison générique
        if (valA < valB) return -1 * currentSort.direction;
        if (valA > valB) return 1 * currentSort.direction;
        return 0;
      });

      displayLeaderboard(sorted);

      // ✅ Mise à jour visuelle des flèches de tri
      document.querySelectorAll("th[data-sort]").forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
      });
      const activeTh = document.querySelector(`th[data-sort="${column}"]`);
      if (activeTh) {
        activeTh.classList.add(currentSort.direction === 1 ? "sorted-asc" : "sorted-desc");
      }
    }


    // Ajout d’un écouteur sur chaque <th>
    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        const column = th.getAttribute("data-sort");
        if (currentSort.column === column) {
          currentSort.direction *= -1; // toggle asc/desc
        } else {
          currentSort.column = column;
          currentSort.direction = 1;
        }
        sortDataBy(column);
      });
    });


    // Initial fetch and display
    fetch(`leaderboard.json?timestamp=${new Date().getTime()}`)
      .then((res) => res.json())
      .then((jsonData) => {
        data = jsonData.players;
        currentSort = { column: "tier", direction: 1 }; // ou -1 pour inverser
        sortDataBy("tier");
      });
  </script>
</body>
</html>
